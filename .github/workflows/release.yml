name: Release Charts

on:
  push:
    branches:
      - main

jobs:
  release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.15.4


      - name: Add Helm repos for dependencies (dynamic)
        shell: bash
        run: |
          set -euo pipefail

          repo_list="$(python3 - <<'PY'
          import glob, hashlib
          import yaml

          def repo_name_for(url: str) -> str:
            h = hashlib.sha1(url.encode("utf-8")).hexdigest()[:10]
            return f"repo-{h}"

          repos = set()

          for chart_yaml in glob.glob("charts/*/Chart.yaml"):
            with open(chart_yaml, "r", encoding="utf-8") as f:
              data = yaml.safe_load(f) or {}
            for dep in (data.get("dependencies") or []):
              repo = (dep or {}).get("repository") or ""
              if repo.startswith("http://") or repo.startswith("https://"):
                repos.add(repo)

          for r in sorted(repos):
            print(f"{repo_name_for(r)}\t{r}")
          PY
          )"

          if [ -z "${repo_list}" ]; then
            echo "==> No HTTP(S) dependency repos found"
          else
            while IFS=$'\t' read -r name url; do
              [ -n "${name}" ] || continue
              echo "==> helm repo add ${name} ${url}"

              # If repo exists, this will fail; ignore and continue
              helm repo add "${name}" "${url}" >/dev/null 2>&1 || true
            done <<< "${repo_list}"

            helm repo update
          fi

      - name: Build chart dependencies (only charts that have deps)
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          for chart_dir in charts/*; do
            [ -d "$chart_dir" ] || continue
            [ -f "$chart_dir/Chart.yaml" ] || continue

            if grep -qE '^[[:space:]]*dependencies:' "$chart_dir/Chart.yaml" || [ -f "$chart_dir/Chart.lock" ]; then
              echo "==> Building dependencies for: $chart_dir"
              helm dependency build "$chart_dir"
            else
              echo "==> No dependencies: $chart_dir"
            fi
          done

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
